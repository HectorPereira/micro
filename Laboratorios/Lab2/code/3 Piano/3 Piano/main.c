/*
Funcionalidades detalladas:

1. Reproducción de Notas:
	o	Cada uno de los 8 pulsadores está asignado a una nota musical
		específica (Do, Re, Mi, Fa, Sol, La, Si, Do agudo).
	o	Al presionar un pulsador, el buzzer reproduce la frecuencia
		correspondiente a la nota seleccionada.

2. Selección de Canciones Predefinidas:
	o	Mediante la comunicación UART, el usuario puede seleccionar
		entre dos canciones almacenadas en el microcontrolador.
	o	Cuando se recibe el comando UART adecuado, el
		microcontrolador detiene la funcionalidad del piano y reproduce la
		canción seleccionada de manera automática.

3. Control por UART:
	o	El sistema recibe comandos a través de UART para seleccionar
		una canción.
	o	Los comandos pueden ser simples, como 'C1' para la primera
		canción y 'C2' para la segunda.
	o	También se puede enviar un comando para detener la
		reproducción de la canción y volver al modo piano
 */ 

#define F_CPU 16000000UL
#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>

#define ARRAY_LEN(array) (sizeof(array) / sizeof(array[0]))
#define G4 392
#define Fb4 370
#define E4 330
#define D4 294
#define A3 220
#define Cb4 277
#define F4 349
#define C4 262
#define Ab3 233
#define A4 440
#define Ab4 466
#define B4 494
#define A2 110
#define D3 147
#define Fb3 185
#define B2 123
#define E3 165
#define G3 196
#define Cb3 139
#define Ab2 117
#define F3 175
#define C3 131
#define G2 98

const int midiA[349][3] PROGMEM = {
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 252, 0},
	{Fb4, 1008, 1765},
	{A3, 252, 0},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 504, 0},
	{Fb4, 756, 0},
	{D4, 504, 0},
	{E4, 252, 0},
	{A3, 751, 1266},
	{A3, 252, 0},
	{E4, 504, 0},
	{Fb4, 252, 0},
	{G4, 756, 0},
	{E4, 252, 0},
	{Cb4, 504, 0},
	{D4, 756, 0},
	{E4, 504, 0},
	{A3, 252, 0},
	{A3, 504, 0},
	{Fb4, 762, 2012},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 252, 0},
	{Fb4, 1008, 1765},
	{A3, 252, 0},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 756, 0},
	{Fb4, 252, 0},
	{D4, 756, 0},
	{E4, 252, 0},
	{A3, 756, 1513},
	{E4, 504, 0},
	{Fb4, 252, 0},
	{G4, 756, 0},
	{E4, 252, 0},
	{Cb4, 756, 0},
	{D4, 252, 0},
	{E4, 504, 0},
	{A3, 252, 0},
	{D4, 252, 0},
	{E4, 252, 0},
	{F4, 252, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{C4, 252, 504},
	{A3, 252, 0},
	{Ab3, 252, 0},
	{C4, 504, 0},
	{F4, 504, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{C4, 504, 0},
	{C4, 504, 0},
	{A3, 252, 0},
	{Ab3, 252, 0},
	{C4, 504, 0},
	{F4, 504, 0},
	{G4, 252, 0},
	{F4, 252, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{D4, 252, 0},
	{E4, 252, 0},
	{F4, 504, 0},
	{F4, 504, 0},
	{G4, 252, 0},
	{A4, 252, 0},
	{Ab4, 252, 0},
	{Ab4, 252, 0},
	{A4, 504, 0},
	{G4, 504, 0},
	{F4, 252, 0},
	{G4, 252, 0},
	{A4, 252, 0},
	{A4, 252, 0},
	{G4, 504, 0},
	{F4, 504, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{D4, 252, 0},
	{F4, 252, 0},
	{F4, 252, 0},
	{E4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 252, 6807},
	{A3, 252, 0},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 378, 0},
	{Fb4, 882, 2017},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 756, 0},
	{Fb4, 252, 0},
	{D4, 504, 0},
	{E4, 504, 0},
	{A3, 756, 1513},
	{E4, 504, 0},
	{Fb4, 252, 0},
	{G4, 756, 0},
	{E4, 504, 0},
	{Cb4, 504, 0},
	{D4, 252, 0},
	{E4, 756, 0},
	{A3, 252, 0},
	{A3, 504, 0},
	{Fb4, 747, 1774},
	{A3, 252, 0},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 252, 0},
	{Fb4, 504, 2269},
	{A3, 252, 0},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 756, 0},
	{Fb4, 252, 0},
	{D4, 756, 0},
	{E4, 252, 0},
	{A3, 756, 1513},
	{E4, 504, 0},
	{Fb4, 252, 0},
	{G4, 756, 0},
	{E4, 504, 0},
	{Cb4, 504, 0},
	{D4, 252, 0},
	{E4, 504, 0},
	{A3, 252, 0},
	{D4, 252, 0},
	{E4, 252, 0},
	{F4, 252, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{C4, 756, 0},
	{A3, 252, 0},
	{Ab3, 252, 0},
	{C4, 504, 0},
	{F4, 504, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{C4, 504, 0},
	{C4, 504, 0},
	{A3, 252, 0},
	{Ab3, 252, 0},
	{C4, 504, 0},
	{F4, 504, 0},
	{G4, 252, 0},
	{F4, 252, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{D4, 252, 0},
	{E4, 252, 0},
	{F4, 504, 0},
	{F4, 504, 0},
	{G4, 252, 0},
	{A4, 252, 0},
	{Ab4, 252, 0},
	{Ab4, 252, 0},
	{A4, 504, 0},
	{G4, 504, 0},
	{F4, 252, 0},
	{G4, 252, 0},
	{A4, 252, 0},
	{A4, 252, 0},
	{G4, 252, 0},
	{F4, 252, 0},
	{F4, 504, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{D4, 252, 0},
	{F4, 252, 0},
	{F4, 252, 0},
	{E4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 760, 6551},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 504, 0},
	{Fb4, 756, 1765},
	{A3, 252, 0},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 756, 0},
	{Fb4, 252, 0},
	{D4, 756, 0},
	{E4, 252, 0},
	{A3, 747, 1522},
	{E4, 504, 0},
	{Fb4, 252, 0},
	{G4, 756, 0},
	{E4, 504, 0},
	{Cb4, 504, 0},
	{D4, 252, 0},
	{E4, 504, 252},
	{A3, 252, 0},
	{A3, 504, 0},
	{Fb4, 772, 2006},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{Fb4, 504, 2274},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{E4, 252, 0},
	{E4, 756, 0},
	{Fb4, 252, 0},
	{D4, 756, 0},
	{E4, 252, 0},
	{A3, 756, 1513},
	{E4, 504, 0},
	{Fb4, 252, 0},
	{G4, 756, 0},
	{E4, 504, 0},
	{Cb4, 504, 0},
	{D4, 252, 0},
	{E4, 504, 0},
	{A3, 252, 0},
	{D4, 252, 0},
	{E4, 252, 0},
	{F4, 252, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{C4, 756, 0},
	{A3, 252, 0},
	{Ab3, 252, 0},
	{C4, 504, 0},
	{F4, 504, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{C4, 504, 0},
	{C4, 504, 0},
	{A3, 252, 0},
	{Ab3, 252, 0},
	{C4, 504, 0},
	{F4, 504, 0},
	{G4, 252, 0},
	{F4, 252, 0},
	{E4, 252, 0},
	{D4, 252, 0},
	{D4, 252, 0},
	{E4, 252, 0},
	{F4, 504, 0},
	{F4, 504, 0},
	{G4, 252, 0},
	{A4, 252, 0},
	{Ab4, 252, 0},
	{Ab4, 252, 0},
	{G4, 252, 5},
	{G4, 504, 0},
	{F4, 252, 0},
	{G4, 252, 0},
	{A4, 252, 0},
	{A4, 252, 0},
	{G4, 252, 0},
	{F4, 252, 0},
	{F4, 504, 0},
	{D4, 252, 0},
	{C4, 252, 0},
	{D4, 252, 0},
	{F4, 252, 0},
	{F4, 252, 0},
	{E4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 760, 999},
	{A4, 252, 0},
	{A4, 252, 0},
	{B4, 252, 0},
	{A4, 252, 0},
	{Fb4, 252, 0},
	{D4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{A4, 756, 756},
	{A4, 252, 0},
	{A4, 252, 0},
	{A4, 252, 0},
	{B4, 252, 0},
	{A4, 252, 0},
	{Fb4, 252, 0},
	{D4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 756, 756},
	{A4, 252, 0},
	{A4, 252, 0},
	{A4, 252, 0},
	{B4, 252, 0},
	{A4, 252, 0},
	{Fb4, 252, 0},
	{D4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 756, 1008},
	{A4, 252, 0},
	{A4, 252, 0},
	{B4, 252, 0},
	{A4, 252, 0},
	{Fb4, 252, 0},
	{D4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 756, 756},
	{A4, 252, 0},
	{A4, 252, 0},
	{A4, 252, 0},
	{B4, 252, 0},
	{A4, 252, 0},
	{Fb4, 252, 0},
	{D4, 504, 0},
	{E4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 756, 756},
	{G4, 252, 0},
	{A4, 252, 0},
	{A4, 756, 756},
	{G4, 252, 0},
	{Fb4, 252, 0},
	{Fb4, 785, 0},
};
const int midiB[433][3] PROGMEM = {
	{F3, 1, 1007},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{E3, 252, 0},
	{B2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{E3, 252, 0},
	{A2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{Cb3, 252, 0},
	{A2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{Cb3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{E3, 252, 0},
	{B2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{E3, 252, 0},
	{A2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{Cb3, 252, 0},
	{A2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{Cb3, 252, 0},
	{Ab2, 252, 0},
	{D3, 252, 0},
	{F3, 252, 15378},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{E3, 756, 0},
	{E3, 252, 0},
	{E3, 252, 0},
	{Fb3, 252, 0},
	{G3, 504, 0},
	{A2, 756, 0},
	{A2, 252, 0},
	{A2, 252, 0},
	{B2, 252, 0},
	{Cb3, 504, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{E3, 756, 0},
	{E3, 252, 0},
	{E3, 252, 0},
	{Fb3, 252, 0},
	{G3, 504, 0},
	{A2, 756, 0},
	{A2, 252, 0},
	{A2, 252, 0},
	{B2, 252, 0},
	{Cb3, 252, 0},
	{A2, 252, 0},
	{Ab2, 504, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{F3, 252, 0},
	{F3, 252, 504},
	{C3, 252, 0},
	{C3, 252, 504},
	{Ab2, 252, 0},
	{Ab2, 252, 504},
	{F3, 252, 0},
	{F3, 252, 504},
	{F3, 252, 0},
	{F3, 252, 504},
	{C3, 252, 0},
	{C3, 252, 504},
	{Ab2, 252, 0},
	{Ab2, 252, 504},
	{F3, 252, 0},
	{F3, 252, 504},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{F3, 252, 0},
	{F3, 252, 0},
	{E3, 252, 0},
	{E3, 252, 0},
	{D3, 252, 0},
	{D3, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{Ab2, 504, 0},
	{F3, 504, 0},
	{A2, 504, 0},
	{E3, 504, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{E3, 252, 0},
	{B2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{E3, 252, 0},
	{A2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{Cb3, 252, 0},
	{A2, 252, 0},
	{E3, 252, 0},
	{G3, 252, 0},
	{Cb3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{A2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{B2, 252, 0},
	{D3, 252, 0},
	{Fb3, 252, 0},
	{D3, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{E3, 756, 0},
	{E3, 252, 0},
	{E3, 252, 0},
	{Fb3, 252, 0},
	{G3, 504, 0},
	{A2, 756, 0},
	{A2, 252, 0},
	{A2, 252, 0},
	{B2, 252, 0},
	{Cb3, 252, 0},
	{A2, 252, 0},
	{Ab2, 504, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{F3, 252, 0},
	{F3, 252, 504},
	{C3, 252, 0},
	{C3, 252, 504},
	{Ab2, 252, 0},
	{Ab2, 252, 504},
	{F3, 252, 0},
	{F3, 252, 504},
	{F3, 252, 0},
	{F3, 252, 504},
	{C3, 252, 0},
	{C3, 252, 504},
	{Ab2, 252, 0},
	{Ab2, 252, 504},
	{F3, 252, 0},
	{F3, 252, 504},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{Ab2, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{F3, 252, 0},
	{F3, 252, 0},
	{E3, 252, 0},
	{E3, 252, 0},
	{D3, 252, 0},
	{D3, 252, 0},
	{C3, 252, 0},
	{C3, 252, 0},
	{Ab2, 504, 0},
	{F3, 504, 0},
	{A2, 504, 0},
	{E3, 504, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 756, 0},
	{B2, 252, 0},
	{D3, 756, 0},
	{D3, 252, 0},
	{B2, 504, 0},
};

uint16_t indexA = 0;
uint16_t countA = 0;
uint16_t maxCountAon = 0;
uint16_t maxCountAoff = 0;
uint8_t enableCountAon = 0;
uint8_t enableCountAoff = 0;

uint16_t indexB = 0;
uint16_t countB = 0;
uint16_t maxCountBon = 0;
uint16_t maxCountBoff = 0;
uint8_t enableCountBon = 0;
uint8_t enableCountBoff = 0;


void read_midi_event(const int (*track)[3], uint16_t index, int out_values[3]) {
	for (uint8_t i = 0; i < 3; i++) {
		out_values[i] = pgm_read_word(&(track[index][i]));
	}
}

// CONFIGURE TIMER 1 FOR 1MS OVERFLOW
// Handles note timing


// Timer 0 handles track A wave generation
void playA(){
	int values[3];
	read_midi_event(midiA, indexA++, values);
	uint16_t freq = values[0];
	maxCountAon = values[1];
	maxCountAoff = values[2];
	
	if (!freq) return;
	DDRD |= (1 << PORTD6);

	uint8_t presc_bits = 0b0; // Valor por defecto
	uint16_t ocr;

	// Probar todos los prescalers
	const uint16_t presc_list[] = {8, 64, 256, 1024};
	const uint8_t  bits_list[]  = { 0b010, 0b011, 0b100, 0b101 };

	for (uint8_t i=0;i<4;i++) {
		ocr = (F_CPU / (2UL * presc_list[i] * freq)) - 1;
		if (ocr <= 255) { presc_bits = bits_list[i]; break; }
	}

	TCCR0A = (1 << COM0A0) | (1 << WGM01);
	TCCR0B = presc_bits;        // prescaler elegido
	OCR0A  = (uint8_t)ocr;
	
	enableCountAon = 1; // Start playing
}

void stopA(void){
	TCCR0B = 0b0;
}


void playB(){
	int values[3];
	read_midi_event(midiB, indexB++, values);
	uint16_t freq = values[0];
	maxCountBon = values[1];
	maxCountBoff = values[2];
	
	if (!freq) return;
	DDRB |= (1 << PORTB3);

	uint8_t presc_bits = 0b0; // Valor por defecto
	uint16_t ocr;

	// Probar todos los prescalers
	const uint16_t presc_list[] = {8, 32, 64, 128, 256, 1024};
	const uint8_t  bits_list[]  = {0b010, 0b011, 0b100, 0b101, 0b110, 0b111 };

	for (uint8_t i=0;i<6;i++) {
		ocr = (F_CPU / (2UL * presc_list[i] * freq)) - 1;
		if (ocr <= 255) { presc_bits = bits_list[i]; break; }
	}

	TCCR2A = (1 << COM2A0) | (1 << WGM21);
	TCCR2B = presc_bits;        // prescaler elegido
	OCR2A  = (uint8_t)ocr;
	
	enableCountBon = 1; // Start playing
}

void stopB(void){
	TCCR2B = 0b0;
}

ISR(TIMER1_OVF_vect){
	TCNT1 = 65536 - 250;  // 1ms preload
	
	if (enableCountAon) {
		if (++countA > maxCountAon) {
			countA = 0;
			enableCountAon = 0;
			enableCountAoff = 1;
			stopA();
		}
		
	} else if (enableCountAoff){
		if (++countA > maxCountAoff){
			countA = 0;
			enableCountAoff = 0;
			playA();
			
		}
	}
	
	if (enableCountBon) {
		if (++countB > maxCountBon) {
			countB = 0;
			enableCountBon = 0;
			enableCountBoff = 1;
			stopB();
		}
		
		} else if (enableCountBoff){
		if (++countB > maxCountBoff){
			countB = 0;
			enableCountBoff = 0;
			playB();
			
		}
	}
	
}

// Overflow = 1ms
void timer1_init(void) {
		TCCR1A = 0x00;
		TCCR1B = (1 << CS11) | (1 << CS10);  // 64
		TCNT1 = 65536 - 250;  
		TIMSK1 |= (1 << TOIE1);
}

		

int main(void) {
	timer1_init();
	sei();
	playA();
	playB();

	while (1);
}